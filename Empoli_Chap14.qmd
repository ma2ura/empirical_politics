# 交差項の使い方

```{r}
#| echo: FALSE
library(tidyverse)
library(ggthemes)
mystyle <- list (#  ggplotのテーマ
  theme_few(), # ggthemesパッケージ
  theme(
    text = element_text(
      size=10,  #  フォントサイズ
      family = "HiraKakuProN-W3" # ヒラギノフォント
    )
  )
)
set.seed(123)
```

## 交差項で何が分かるのか

説明変数$X$が応答変数$Y$に与える影響(直接効果)に対して，別の説明変数$Z$が与える影響がある場合，$X$と$Z$の交差項$X \times Z$をモデルに組み入れることで，$X$の影響が$Z$の値によってどのように変化するかを分析することができます。

$$
Y = \beta_0 + \beta_1 X + \beta_2 Z + \beta_3 X \times Z + \varepsilon
$$

この$X \times Z$を**交差項**(interaction term)とよびます。

前章で導入したダミー変数との交差項は，ダミー変数の値によって，切片や傾きがどのように変化するかを分析することができましたが，ここでは量的変数と量的変数の交差項のケースを考えます。


## 交差項を入れた回帰分析の注意点

回帰分析で交差項を入れる場合の注意点は次の4つです。

1. 条件付仮説(たとえば，十分に$Z$が大きいとき，$X$は$Y$に影響を与える，とか)を検証する場合に，交差項を使う。
2. 交差項を入れるときは，交差項を構成する変数をそれぞれ回帰モデルに入れる。
3. 交差項を構成する変数の回帰係数はそのまま解釈できない。
4. 分析結果として，限界効果と標準誤差を示す。


これは，数式で確認すれば分かりやすいです。
回帰モデルが

$$
Y = \beta_0 + \beta_1 X + \beta_2 Z + \beta_3 X \times Z + \varepsilon
$$

であるとき，$X$の影響は，$Y$を$X$で偏微分することで求められます。

$$
\frac{\partial Y}{\partial X} = \beta_1 + \beta_3 Z
$$

この式から，$Z$の値によって，$X$の影響が変化することが分かります。
そのため，$\beta_1$の値だけでは，$X$の影響を正確に評価することができません。また，$Z$の値によって，$X$の影響が変化することを示すためには，$Z$の値を変化させたときの$\beta_1$の値を示す必要があります。これを**限界効果**(marginal effect)とよびます。

## 広告宣伝費を事例とした交差項の分析

以下の分析で利用するためのデータを読み込みます。
ここでも，`tidyverse`パッケージ群の`read_csv()`関数を使います。

```{r}
df <- read_csv("data/adv_2023.csv") # データの読み込み
df <- df %>%
  select(-拡販費) %>% # 必要ないデータを除去
  filter(決算月数 == 12) %>% # 決算月数が12のデータを抽出
  filter(広告宣伝費 > 0)  # 広告宣伝費が0のデータを除去
glimpse(df)
```

以下では，応答変数として売上高，説明変数として広告宣伝費と設備投資額を使います。

### 記述統計と散布図の表示

主要変数3つの記述統計をみます。
ここでは`summary()`関数を使います。

```{r}
df3 <- df[, c("売上高", "広告宣伝費", "設備投資額")]
summary(df3)
```

これでも良いのですが，`skimr`パッケージと`summarytools`パッケージを使うと，より見やすい表を作ることが出来ます。

```{r}
# install.packages("skimr") # first time only
library(skimr)
skim(df3)
```

あるいは，`summarytools`パッケージの`descr()`関数を使っても見やすい表を作ることが出来ます。

```{r}
# install.packages("summarytools") # first time only
library(summarytools)
descr(df3, transpose = TRUE)
```

また，`summarytools`パッケージの`dfSummary()`関数を使うと，データフレームの形で表を作ることが出来ます。

```{r}
df3 %>%
  dfSummary(
    plain.ascii = FALSE,
    style        = 'grid',
    graph.magnif = 0.85,
    varnumbers = FALSE,
    valid.col    = FALSE) %>%
    print(method = "render")
```

好きな方法を使ってください。

次に，散布図を描きます。

```{r}
df3 %>%
  ggplot(aes(x = 設備投資額, y = 売上高)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "設備投資額", y = "売上高") + mystyle
```

設備投資額が多い企業ほど売上高が多いように見えますが，因果関係を明らかにするためにも，広告宣伝費と翌期の売上高の散布図を書いてみます。ついでに両変数を対数変換して，分布を正規分布に近づけておきます。

```{r}
df3 %>%
  ggplot() + aes(x = log(lag(設備投資額)), y = log(売上高)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE) +
  labs(x = "前期対数設備投資額", y = "対数売上高") + mystyle
```

次に，この設備投資額と売上高の関係に広告宣伝費がどのような影響を与えているのかを調べるために，回帰モデルに交差項を組み込んでいきます。

### 交差項を使った重回帰分析

ここでは，次のような仮説を考えてみます。

> 広告宣伝費が多い企業ほど，設備投資額が多いと，売上高が増加する。

この仮説を検証するために，回帰モデルを次のように設定します。

$$
\begin{aligned}
\log \text{売上高} = \beta_0 &+ \beta_1 \log \text{前期設備投資額} + \beta_2 \log \text{広告宣伝費} \\

& + \beta_3 \log \text{前期設備投資額} \times \log \text{広告宣伝費} + \varepsilon
\end{aligned}
$$

これを`lm()`関数を使って回帰分析を行います。
`lm()`関すで交差項を含む回帰モデルを作るときは，`*`を使います。
推定結果を`modelsummary`パッケージを使って表示します。

```{r}
library(modelsummary)
res01 <- lm(log(売上高) ~ log(設備投資額) * log(広告宣伝費), data = df3)
modelsummary(res01,
  stars = c("*" = .10, "**" = .05, "***" = .01),
  gof_omit = "AIC|BIC|logLik",
  )
```

この結果から，設備投資と売上高の正の関係は，広告宣伝費が大きくなるほど強くなる，ということが分かりました。
この結果の解釈を容易にするために，`margins`パッケージを使って限界効果を計算します。

```{r}
# install.packages("margins") # first time only
library(margins)
margins(res01)
```

この限界効果の推定から，広告宣伝費が増加すると，設備投資と売上高の正の関係が強くなることが分かります。


### 交差項を含む回帰分析結果の解釈と可視化

上の分析結果から，設備投資額と売上高との関係は，広告宣伝費の規模に応じて変化することが分かりました。
しかし，前述した通り設備投資額が売上高に与える影響の強さは，広告宣伝費に応じて決まるため，設備投資額が1円増えたとき，売上高がいくら増えるのかはこの推定結果からは分かりません。

そこで，説明変数を中心化することで，推定結果を解釈可能なものにします。
前章と同様に，中心化するために，各説明変数から標本平均を引きます。
ここでは，`scale()`関数を使って中心化します。

```{r}
df3 <- df3 %>%
  mutate(
    log広告宣伝費_c = scale(log(広告宣伝費)),
    log設備投資額_c = scale(log(設備投資額))
  )
res02 <- lm(log(売上高) ~ log設備投資額_c * log広告宣伝費_c, data = df3)
modelsummary(res02,
  stars = c("*" = .10, "**" = .05, "***" = .01),
  gof_omit = "AIC|BIC|logLik",
  )
```

```{r}
df3 <- df3 %>%
  mutate(
    log広告宣伝費 = log(広告宣伝費),
    log設備投資額 = log(設備投資額),
    log広告宣伝費_c = log広告宣伝費 - mean(log広告宣伝費),
    log設備投資額_c = log設備投資額 - mean(log設備投資額)
  )
```

## まとめ
